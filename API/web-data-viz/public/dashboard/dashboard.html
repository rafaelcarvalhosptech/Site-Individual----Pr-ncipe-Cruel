<!DOCTYPE html>
<html lang="pt-br">

<head>
  <link rel="shortcut icon" href="" type="image/x-icon">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Principe Cruel | Dashboards</title>

  <link rel="stylesheet" href="./../css/dashboards.css">
  <link rel="stylesheet" href="./../css/estilo.css" />
  <script src="../js/sessao.js"></script>
  <script src="./../js/alerta.js"></script>

  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Exo+2:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <div class="janela">
    <div class="header-left">
      <img class="fundoHeader" src="../assets/imgs/imgs/logo-dash.png" alt="">

      <div class="hello">
        <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
      </div>

      <div class="btn-nav-white">
        <a href="./dashboard.html">
          <h3>Gráficos</h3>
        </a>
      </div>

     

      <div class="btn-logout" onclick="limparSessao()">
        <h3>Sair</h3>
      </div>

    </div>
    <div class="dash">
      <div id="alerta"></div>
      <div class="area-parametros-alerta">
        <p class="titulo-legenda">Parâmetros para Rank de Leitor:</p>

        <div class="parametros-alerta">
          <div class="item-regua perigo-frio">
            <p>leitor inciante</p>
            <p>20 pontos</p>
          </div>
          <div class="item-regua alerta-frio">
            <p>leitor casual</p>
            <p>40 pontos</p>
          </div>
          <div class="item-regua ideal">
            <p>Leitor dedicado</p>
            <p>60 pontos</p>
          </div>
          <div class="item-regua alerta-quente">
            <p>Leitor ávido </p>
            <p>80 pontos</p>
          </div>
          <div class="item-regua perigo-quente">
            <p>Mestre literário </p>
            <p>100 pontos</p>
          </div>
        </div>
      </div>

      <div class="dash">
        <div id="alerta"></div>
        <div class="kpi">
           <div class="kpi-card">
          <h3>Média dos usuários</h3>
          <p id="kpi_media" class="kpi-value">--</p>
        </div>

        <div class="kpi-card">
          <h3>Seu rank</h3>
          <p id="kpi_usuario" class="kpi-value">--</p>
        </div>
        </div>
      <div class="legenda-grafico">
         <h1>Gráfico dos usuários cadastrados:</h1>
      </div>
       

      
        <div class="btns-dash" id="btnTorcedor">
          <canvas id="grafico_Dado"></canvas>
        </div>

        <div id="graficos"></div>


      
    </div>

</body>

</html>

<script>

  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  window.onload = function () {
    obterDadosGrafico();
    buscarMediaGeral();
    buscarKpiUsuario();
  };



  // Grafico

  function obterDadosGrafico() {
    fetch(`/graficos/dadosDados`, { cache: 'no-store' })
      .then(function (resposta) {
        if (resposta.ok) {
          resposta.json().then(function (resposta) {
            plotarGrafico(resposta);
          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
        }
      })
      .catch(function (error) {
        console.error('Erro na obtenção dos dados p/ gráfico: ' + error.message);
      });
  }




  function plotarGrafico(resposta) {
    const nomesDados = [];
    const valoresDados = [];

    for (let i = 0; i < resposta.length; i++) {
      let registro = resposta[i];


      const nome = registro.Dado ?? registro.Dados ?? registro.nomeDado ?? registro.team ?? (`Dado ${registro.idDado ?? i + 1}`);


      const valorBruto = registro.QuantidadeTotal ?? registro.quantidade ?? registro.valor ?? 0;
      const valor = Number.isFinite(Number(valorBruto)) ? Math.round(Number(valorBruto)) : 0;

      nomesDados.push(String(nome));
      valoresDados.push(valor);
    }

    if (nomesDados.length === 0) {
      document.getElementById('graficos').innerHTML = "<p style='color:#fff'>Nenhum dado de torcedores disponível.</p>";
      return;
    }

    const maxVal = Math.max(...valoresDados, 1);
    const passo = Math.max(1, Math.ceil(maxVal / 5));

    const dados = {
      labels: nomesDados,
      datasets: [{
        label: 'Quantidade de torcedores por Dado',
        data: valoresDados,
        borderColor: '#bdff7b',
        borderWidth: 1
      }]
    };

    const configuracao = {
      type: 'bar',
      data: dados,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { autoSkip: false, color: '#ffffff' }, title: { display: true, text: 'Dados', color: '#ffffff' } },
          y: { beginAtZero: true, max: Math.ceil(maxVal / passo) * passo, ticks: { stepSize: passo, color: '#ffffff' }, title: { display: true, text: 'Quantidade de usuários', color: '#ffffff' } }
        },
        plugins: { legend: { display: false } }
      }
    };

    const canvas = document.getElementById('grafico_Dado');
    if (!canvas) return;

    if (canvas._graficoInstancia) {
      try { canvas._graficoInstancia; } catch (e) { }
      canvas._graficoInstancia = null;
    }

    canvas.style.height = '500px';
    const grafico = new Chart(canvas.getContext('2d'), configuracao);
    canvas._graficoInstancia = grafico;
  }


  // KPI's

  function buscarMediaGeral() {
    fetch("/usuarios/kpi/media")
      .then(resp => {
        if (!resp.ok) throw new Error("Erro na API média: " + resp.status);
        return resp.json();
      })
      .then(json => {
        let valor = "--";
        if (Array.isArray(json) && json.length > 0) valor = json[0].mediaNivel ?? json[0].media ?? "--";
        else if (json && typeof json === 'object') valor = json.media ?? json.mediaNivel ?? "--";
        document.getElementById("kpi_media").innerText = valor;
      })
      .catch(err => {
        document.getElementById("kpi_media").innerText = "--";
      });
  }




  function buscarKpiUsuario() {
    const id = sessionStorage.ID_USUARIO;
    if (!id) {
      document.getElementById("kpi_usuario").innerText = "--";
      return;
    }

    fetch(`/usuarios/kpiUsuario/${id}`)
      .then(resp => {
        if (!resp.ok) throw new Error("Erro na API kpi usuario: " + resp.status);
        return resp.json();
      })
      .then(json => {
        let nivel = json.nivelTorcedor ?? json.nivel ?? json.NIVEL ?? "--";
        document.getElementById("kpi_usuario").innerText = nivel;
      })
      .catch(err => {
        document.getElementById("kpi_usuario").innerText = "--";
      });
  }

</script>